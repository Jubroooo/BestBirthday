{% extends '../base.html' %}
{% load static %}
{% block head %}
<link rel="stylesheet" href="{% static 'css/fundings/result_start.css' %}">
{% endblock head %}

{% block header %}
<div class="show-card-title">
    <i onClick="history.go(-1)" class="icon-left fa-solid fa-chevron-left"></i>
    <p class="title-go-see-letter notosans-bold-20">생일 편지 보기</p>
</div>
{% endblock header %}

{% block content %}
<div class="congrats-section">
    <canvas id="c" width="360" height="360"></canvas>
</div>
<p class="notosans-bold-18 letters-congrats first-line-congrats">{{funding.user.nickname}}님 생일을 진심으로 축하합니다</p>
<p class="notosans-bold-18 letters-congrats">축하 메세지 <span class="highlight-blue notosans-bold-18">{{funding_msg_count}}개</span>와 <span class="highlight-blue notosans-bold-18"> {{funding.total_price}}</span>원이 쌓였어요</p>
{%if earliest_msg %}
<p class="notosans-bold-16 filter-congrats">가장 먼저 축하해 준 친구  <span class="highlight-blue notosans-bold-18"> {{earliest_msg.comment_name}}</span></p>
<p class="notosans-bold-16 filter-congrats">가장 길게 축하해 준 친구 <span class="highlight-blue notosans-bold-18"> {{longest_msg.comment_name}}</span></p>

{%else%}
<p class="notosans-bold-16 no-messages">축하해 준 친구가 없어요. ㅠㅠ</p>
{%endif%}
<div class="delivered-messages">
    {%for funding_msg in funding_msgs%}
    <a href="#" data-message-id="{{ funding_msg.id }}" class="b-day-message">
        <div>
            <span class="message-number notosans-bold-16">{{ forloop.counter }}</span>
            <span class="message-sender notosans-regular-14 ">{{funding_msg.comment_name}}</span>
        </div>
        <span class="message-date notosans-regular-14 ">{{funding_msg.written_date}}</span>
    </a>
    {%endfor%}
</div>
<div class="div-btn">
    <p class="notosans-bold-18">공유하기</p>
</div>
<div id="messageModal" class="modal">
    <div class="modal-content">
        <p id="modalMessageContent">메시지 내용이 여기에 표시됨</p>
        <div class="div-btn close">
            <p class="notosans-bold-18">편지 닫기</p>
        </div>
    </div>
</div>
{% endblock %}

{% block script %}
<script>
//편지 디테일 모달을 위한 
document.addEventListener("DOMContentLoaded", function() {
    // 메시지 클릭 이벤트 리스너
    document.querySelectorAll('.b-day-message').forEach(function(messageLink) {
        messageLink.addEventListener('click', function(e) {
            e.preventDefault(); // 기본 링크 동작 방지

            const messageId = this.getAttribute('data-message-id'); // 메시지 ID 가져오기
            // AJAX 요청으로 메시지 상세 내용 가져오기
               fetch(`http://127.0.0.1:8000/result_detail/${messageId}`)
                .then(response => response.text())
                .then(data => {
                    document.getElementById('modalMessageContent').innerHTML = data; // 모달 내용 업데이트
                    document.getElementById('messageModal').style.display = 'block'; // 모달 표시
                });
        });
    });

    // 닫기 버튼 클릭 이벤트 리스너
    document.querySelector('.close').addEventListener('click', function() {
        document.getElementById('messageModal').style.display = 'none'; // 모달 숨기기
    });
});

//애니메이션
document.addEventListener('DOMContentLoaded', () => {
    const observer = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add('visible');
                observer.unobserve(entry.target); // 애니메이션이 적용된 후에는 더 이상 관찰하지 않음
            }
        });
    }, {
        threshold: 0.5 // 타겟 요소의 50%가 보일 때 
    });

    // 관찰할 대상 설정
    const elements = document.querySelectorAll('.letters-congrats');
    elements.forEach(el => observer.observe(el));
});

//풍선 애니메이션
var c = document.getElementById("c");
var ctx = c.getContext("2d");

var bc = document.createElement("canvas");
var bCtx = bc.getContext("2d");

var cw = c.width = bc.width = 390,
  cx = cw / 2;
/*내부 스크롤 방지 위해 canvas 높이 조정 헤더가 104px*/
var ch = c.height = bc.height = 390,
  cy = ch;


var frames = 0;
var requestId = null;
var rad = (Math.PI / 180);
var kappa = 0.5522847498;

var x, y;
bCtx.strokeStyle = "#abcdef";
bCtx.lineWidth = 1;

var balloons = [];

function Balloon() {
  this.r = randomIntFromInterval(20, 70);
  this.R = 1.4 * this.r;
  this.x = randomIntFromInterval(this.r, cw - this.r);
  this.y = ch + 2 * this.r;
  this.a = this.r * 4.5;
  this.pm = Math.random() < 0.5 ? -1 : 1;
  this.speed = randomIntFromInterval(2.5,3.8);
  this.k = this.speed / 5;
  this.hue = this.pm > 0 ? "210" : "10";
}

function Draw() {

  updateBallons(bCtx);

  ctx.clearRect(0, 0, cw, ch);
  var img = bc;
  ctx.drawImage(img, 0, 0);

  requestId = window.requestAnimationFrame(Draw);
}
//requestId = window.requestAnimationFrame(Draw);

function Init() {
  if (requestId) {
    window.cancelAnimationFrame(requestId);
    requestId = null;
  }
  cw = c.width = bc.width = 390, cx = cw / 2;
  ch = c.height = bc.height = window.innerHeight-200, cy = ch;
  bCtx.strokeStyle = "#abcdef";
  bCtx.lineWidth = 1;
  Draw();
}

setTimeout(function() {
  Init();
  window.addEventListener('resize', Init, false);
}, 15);

function updateBallons(ctx) {
  frames += 1;
  if (frames % 70 == 0 && balloons.length < 20) {
    var balloon = new Balloon();
    balloons.push(balloon);
  }
  ctx.clearRect(0, 0, cw, ch);

  var colorIndex = 0;
  for (var i = 0; i < balloons.length; i++) {
    var b = balloons[i];
    if (b.y > -b.a) {
      b.y -= b.speed
    } else {
      b.y = parseInt(ch + b.r + b.R);
    }

    var p = thread(b, ctx);
    b.cx = p.x;
    b.cy = p.y - b.R;

    // 투명도 값 설정
    var alpha = 0.8; // 원하는 투명도 값 (0에서 1 사이의 값)
    
    // 색상과 투명도 값을 전달하여 그라데이션 생성
    ctx.fillStyle = Grd(p.x, p.y, b.r, colorIndex, alpha);
    colorIndex = (colorIndex + 1) % colors.length; // 다음 색상을 선택하기 위해 인덱스 업데이트

    drawBalloon(b, ctx);
  }
}

function drawBalloon(b, ctx) {

  var or = b.r * kappa; // offset

  var p1 = {
    x: b.cx - b.r,
    y: b.cy
  }
  var pc11 = {
    x: p1.x,
    y: p1.y + or
  }
  var pc12 = {
    x: p1.x,
    y: p1.y - or
  }

  var p2 = {
    x: b.cx,
    y: b.cy - b.r
  }
  var pc21 = {
    x: b.cx - or,
    y: p2.y
  }
  var pc22 = {
    x: b.cx + or,
    y: p2.y
  }

  var p3 = {
    x: b.cx + b.r,
    y: b.cy
  }
  var pc31 = {
    x: p3.x,
    y: p3.y - or
  }
  var pc32 = {
    x: p3.x,
    y: p3.y + or
  }

  var p4 = {
    x: b.cx,
    y: b.cy + b.R
  };
  var pc41 = {
    x: p4.x + or,
    y: p4.y
  }
  var pc42 = {
    x: p4.x - or,
    y: p4.y
  }

  var t1 = {
    x: p4.x + .2 * b.r * Math.cos(70 * rad),
    y: p4.y + .2 * b.r * Math.sin(70 * rad)
  }
  var t2 = {
    x: p4.x + .2 * b.r * Math.cos(110 * rad),
    y: p4.y + .2 * b.r * Math.sin(110 * rad)
  }

  //balloon
  ctx.beginPath();
  ctx.moveTo(p4.x, p4.y);
  ctx.bezierCurveTo(pc42.x, pc42.y, pc11.x, pc11.y, p1.x, p1.y);
  ctx.bezierCurveTo(pc12.x, pc12.y, pc21.x, pc21.y, p2.x, p2.y);
  ctx.bezierCurveTo(pc22.x, pc22.y, pc31.x, pc31.y, p3.x, p3.y);
  ctx.bezierCurveTo(pc32.x, pc32.y, pc41.x, pc41.y, p4.x, p4.y);
  //knot
  ctx.lineTo(t1.x, t1.y);
  ctx.lineTo(t2.x, t2.y);
  ctx.closePath();
  ctx.fill();
}

function thread(b, ctx) {
  ctx.beginPath();

  for (var i = b.a; i > 0; i -= 1) {
    var t = i * rad;
    x = b.x + b.pm * 50 * Math.cos(b.k * t - frames * rad)
    y = b.y + b.pm * 25 * Math.sin(b.k * t - frames * rad) + 50 * t
    ctx.lineTo(x, y)
  }
  ctx.stroke();
  return p = {
    x: x,
    y: y
  }
}

var colors = ["#4114FF", "#FF6245", "#00FF00", "#FFD700"]; // 원하는 색상 추가 가능

function Grd(x, y, r, index, alpha) {
    var hue = colors[index % colors.length]; // 인덱스에 따라 순환하여 색상 선택
    var rgbaColor = 'rgba(' + parseInt(hue.slice(1, 3), 16) + ', ' + parseInt(hue.slice(3, 5), 16) + ', ' + parseInt(hue.slice(5, 7), 16) + ', ' + alpha + ')';
    grd = ctx.createRadialGradient(x - .5 * r, y - 1.7 * r, 0, x - .5 * r, y - 1.7 * r, r);
    grd.addColorStop(0, rgbaColor);
    grd.addColorStop(0.4, rgbaColor);
    grd.addColorStop(1, rgbaColor);
    return grd;
  }

function randomIntFromInterval(mn, mx) {
  return ~~(Math.random() * (mx - mn + 1) + mn);
}
</script>
{% endblock%}